<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balc√£o - O Retiro 2025</title>
    <style>
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #4a90e2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-light: #ffffff;
            --text-muted: #cccccc;
            --border-color: #444;
            --gradient-bg: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: var(--gradient-bg);
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        .user-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .control-panel {
            background: var(--gradient-bg);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .control-panel h2 {
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .search-section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--dark-bg);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .results-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .results-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .participant-card {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .participant-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .participant-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-light);
            flex: 1;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-aguardando {
            background: #ffc107;
            color: #000;
        }

        .status-parcial {
            background: #17a2b8;
            color: white;
        }

        .status-pago {
            background: #28a745;
            color: white;
        }

        .participant-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .info-icon {
            color: var(--primary-color);
        }

        .participant-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .btn-small {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .close {
            color: var(--text-muted);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--dark-bg);
            color: var(--text-light);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
            color: #000;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--dark-bg);
        }

        .login-card {
            background: var(--card-bg);
            padding: 3rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            border: 2px solid var(--primary-color);
        }

        .login-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--primary-color);
        }

        .confirmation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: black;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1002;
            text-align: center;
            min-width: 300px;
        }

        .confirmation-popup h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .confirmation-popup .btn {
            margin: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
            
            .participant-actions {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h2 class="login-title">üîê Sistema de Balc√£o</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">E-mail:</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha:</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üöÄ ENTRAR
                </button>
            </form>
        </div>
    </div>

    <!-- Tela Principal -->
    <div id="mainScreen" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" onclick="logout()">üö™ SAIR</button>
            </div>
            <h1>SISTEMA DE BALC√ÉO</h1>
            <p>O RETIRO ‚Ä¢ GEST√ÉO DE PAGAMENTOS</p>
        </header>

        <div class="container">
            <!-- Painel de Controle -->
            <div class="control-panel">
                <h2>üìä PAINEL DE CONTROLE</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statHomens">0</div>
                        <div class="stat-label">Inscritos Homens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statMulheres">0</div>
                        <div class="stat-label">Inscritas Mulheres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="stat-label">Total de Inscri√ß√µes</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openDashboard()">
                        üìä DASHBOARD COMPLETO
                    </button>
                    <button class="btn btn-warning" onclick="openWinnersList()">
                        üèÜ LISTA DE GANHADORES
                    </button>
                </div>
            </div>

            <!-- Se√ß√£o de Busca -->
            <div class="search-section">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" 
                           placeholder="Digite o nome do participante..." 
                           onkeyup="searchParticipants()">
                </div>
            </div>

            <!-- Resultados da Busca -->
            <div class="results-section">
                <div class="results-header">
                    <span>üìã</span>
                    <span>RESULTADOS DA BUSCA</span>
                </div>
                <div id="searchResults">
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Digite o nome de um participante para come√ßar a busca...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cobran√ßa -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ Cobrar Participante</h2>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div id="paymentModalContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìã Detalhes Completos</h2>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div id="detailsModalContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de E-mail -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìß Enviar Comprovante por E-mail</h2>
                <span class="close" onclick="closeEmailModal()">&times;</span>
            </div>
            <div id="emailModalContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√µes do Supabase
        const SUPABASE_URL = 'https://yuikwufjkdzgdzvlotaq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1aWt3dWZqa2R6Z2R6dmxvdGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5ODcwMzcsImV4cCI6MjA2NjU2MzAzN30.UGW0AHHSsIv842Z92F6RjI930fgS-5FmPX0i7kumgYo';
        
        // Configura√ß√£o do Resend
        const RESEND_API_KEY = 're_arnckxhd_7xGQ1cuDeEpC8oBXGtMFHNH4';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Vari√°veis globais
        let currentUser = null;
        let allParticipants = [];
        let currentParticipant = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema iniciando...');
            checkAuthState();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', debounce(searchParticipants, 300));
            
            // Modal clicks
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });
        }

        // Autentica√ß√£o
        async function checkAuthState() {
            console.log('üîê Verificando autentica√ß√£o...');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    console.log('‚úÖ Usu√°rio autenticado:', session.user.email);
                    currentUser = session.user;
                    showMainScreen();
                    await loadDashboardData();
                } else {
                    console.log('‚ùå Usu√°rio n√£o autenticado');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
                showLoginScreen();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            console.log('üîë Tentando login para:', email);
            showLoading(true);
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                console.log('‚úÖ Login realizado com sucesso');
                currentUser = data.user;
                showMainScreen();
                await loadDashboardData();
                showNotification('Login realizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                showNotification('Erro no login: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function logout() {
            console.log('üö™ Fazendo logout...');
            await supabase.auth.signOut();
            currentUser = null;
            allParticipants = [];
            showLoginScreen();
            showNotification('Logout realizado com sucesso!', 'success');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.email;
        }

        // Carregamento de dados
        async function loadDashboardData() {
            console.log('üìä Carregando dados do dashboard...');
            showLoading(true);
            
            try {
                const { data, error } = await supabase
                    .from('inscricoes')
                    .select('*')
                    .order('criado_em', { ascending: false });
                
                if (error) throw error;
                
                allParticipants = data || [];
                console.log(`‚úÖ ${allParticipants.length} participantes carregados`);
                
                updateDashboardStats();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateDashboardStats() {
            console.log('üìà Atualizando estat√≠sticas...');
            
            // Contar apenas quem pagou (parcial ou integral)
            const paidParticipants = allParticipants.filter(p => {
                const valorPago = parseFloat(p.valor_pago || 0);
                return valorPago > 0;
            });
            
            const homens = paidParticipants.filter(p => p.sexo === 'MASCULINO').length;
            const mulheres = paidParticipants.filter(p => p.sexo === 'FEMININO').length;
            const total = paidParticipants.length;
            
            console.log(`üìä Estat√≠sticas: ${homens} homens, ${mulheres} mulheres, ${total} total`);
            
            document.getElementById('statHomens').textContent = homens;
            document.getElementById('statMulheres').textContent = mulheres;
            document.getElementById('statTotal').textContent = total;
        }

        // Busca de participantes
        function searchParticipants() {
            const searchTerm = document.getElementById('searchInput').value.trim().toUpperCase();
            
            if (searchTerm.length < 2) {
                document.getElementById('searchResults').innerHTML = `
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Digite pelo menos 2 caracteres para buscar...
                    </p>
                `;
                return;
            }
            
            console.log('üîç Buscando por:', searchTerm);
            
            const results = allParticipants.filter(participant => 
                participant.nome_completo && 
                participant.nome_completo.toUpperCase().includes(searchTerm)
            );
            
            console.log(`üîç ${results.length} resultados encontrados`);
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Nenhum participante encontrado...
                    </p>
                `;
                return;
            }
            
            container.innerHTML = results.map(participant => createParticipantCard(participant)).join('');
        }

        function createParticipantCard(participant) {
            const status = getParticipantStatus(participant);
            const statusClass = getStatusClass(status);
            
            return `
                <div class="participant-card">
                    <div class="participant-header">
                        <div class="participant-name">${participant.nome_completo || 'Nome n√£o informado'}</div>
                        <div class="status-badge ${statusClass}">${status}</div>
                    </div>
                    <div class="participant-info">
                        <div class="info-item">
                            <span class="info-icon">üì±</span>
                            <span>WhatsApp: ${participant.whatsapp || 'N√£o informado'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üë§</span>
                            <span>Sexo: ${participant.sexo || 'N√£o informado'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üí∞</span>
                            <span>Valor Pago: R$ ${participant.valor_pago || '0,00'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üí≥</span>
                            <span>Forma: ${participant.forma_pagamento || 'N√£o informado'}</span>
                        </div>
                    </div>
                    <div class="participant-actions">
                        <button class="btn btn-success btn-small" onclick="openPaymentModal(${participant.id})">
                            üí∞ COBRAR
                        </button>
                        <button class="btn btn-primary btn-small" onclick="openDetailsModal(${participant.id})">
                            üìã DETALHES
                        </button>
                        <button class="btn btn-warning btn-small" onclick="openEmailModal(${participant.id})">
                            üìß E-MAIL
                        </button>
                    </div>
                </div>
            `;
        }

        function getParticipantStatus(participant) {
            const valorPago = parseFloat(participant.valor_pago || 0);
            
            if (valorPago === 0) {
                return 'AGUARDANDO PAGAMENTO';
            } else if (valorPago >= 520) {
                return 'PAGO';
            } else if (valorPago >= 150) {
                return 'PAGAMENTO PARCIAL';
            } else {
                return 'AGUARDANDO PAGAMENTO';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'AGUARDANDO PAGAMENTO':
                    return 'status-aguardando';
                case 'PAGAMENTO PARCIAL':
                    return 'status-parcial';
                case 'PAGO':
                    return 'status-pago';
                default:
                    return 'status-aguardando';
            }
        }

        // Modal de Cobran√ßa
        async function openPaymentModal(participantId) {
            console.log('üí∞ Abrindo modal de cobran√ßa para ID:', participantId);
            
            currentParticipant = allParticipants.find(p => p.id === participantId);
            if (!currentParticipant) {
                console.error('‚ùå Participante n√£o encontrado');
                return;
            }
            
            const valorAtual = parseFloat(currentParticipant.valor_pago || 0);
            const valorRestante = 520 - valorAtual;
            const valorSugerido = valorAtual === 0 ? 150 : valorRestante;
            
            document.getElementById('paymentModalContent').innerHTML = `
                <div class="form-group">
                    <h3>${currentParticipant.nome_completo}</h3>
                    <p><strong>WhatsApp:</strong> ${currentParticipant.whatsapp}</p>
                    <p><strong>Status Atual:</strong> ${getParticipantStatus(currentParticipant)}</p>
                    <p><strong>Valor J√° Pago:</strong> R$ ${valorAtual.toFixed(2)}</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üè∑Ô∏è Novo Status:</label>
                        <select id="newStatus" class="form-control" onchange="updateSuggestedValue()">
                            <option value="">Selecione...</option>
                            <option value="PRE_INSCRICAO">Pr√©-inscri√ß√£o (R$ 150)</option>
                            <option value="PAGO_COMPLETO">Pago Completo (R$ 520)</option>
                            <option value="PENDENTE">Pendente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí≥ Forma de Pagamento:</label>
                        <select id="paymentMethod" class="form-control">
                            <option value="PIX">PIX</option>
                            <option value="DINHEIRO">Dinheiro</option>
                            <option value="CARTAO_CREDITO">Cart√£o de Cr√©dito</option>
                            <option value="CARTAO_DEBITO">Cart√£o de D√©bito</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Valor a Cobrar:</label>
                    <input type="number" id="paymentAmount" class="form-control" 
                           value="${valorSugerido.toFixed(2)}" step="0.01" min="0">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-success" onclick="processPayment()">
                        ‚úÖ CONFIRMAR COBRAN√áA
                    </button>
                    <button class="btn btn-danger" onclick="closePaymentModal()">
                        ‚ùå CANCELAR
                    </button>
                </div>
            `;
            
            document.getElementById('paymentModal').style.display = 'block';
        }

        function updateSuggestedValue() {
            const status = document.getElementById('newStatus').value;
            const amountInput = document.getElementById('paymentAmount');
            const valorAtual = parseFloat(currentParticipant.valor_pago || 0);
            
            switch (status) {
                case 'PRE_INSCRICAO':
                    amountInput.value = Math.max(0, 150 - valorAtual).toFixed(2);
                    break;
                case 'PAGO_COMPLETO':
                    amountInput.value = Math.max(0, 520 - valorAtual).toFixed(2);
                    break;
                case 'PENDENTE':
                    amountInput.value = '0.00';
                    break;
            }
        }

        async function processPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            
            if (!amount || amount <= 0) {
                showNotification('Valor inv√°lido!', 'error');
                return;
            }
            
            console.log(`üí∞ Processando pagamento: R$ ${amount} via ${method}`);
            
            // Mostrar popup de confirma√ß√£o
            showConfirmationPopup(
                `Confirmar cobran√ßa de R$ ${amount.toFixed(2)} via ${method}?`,
                async () => {
                    showLoading(true);
                    
                    try {
                        const valorAtual = parseFloat(currentParticipant.valor_pago || 0);
                        const novoValorTotal = valorAtual + amount;
                        
                        // Determinar status baseado no valor total
                        let statusFinal;
                        if (novoValorTotal >= 520) {
                            statusFinal = 'PAGO';
                        } else if (novoValorTotal >= 150) {
                            statusFinal = 'PAGAMENTO PARCIAL';
                        } else {
                            statusFinal = 'AGUARDANDO PAGAMENTO';
                        }
                        
                        console.log(`üíæ Atualizando banco: valor ${novoValorTotal}, status ${statusFinal}`);
                        
                        // Atualizar no banco
                        const { error } = await supabase
                            .from('inscricoes')
                            .update({
                                valor_pago: novoValorTotal.toFixed(2),
                                forma_pagamento: method,
                                status_pagamento: statusFinal,
                                atendente_ultimo_pagamento: currentUser.email,
                                dados_√∫ltimo_pagamento: new Date().toISOString(),
                                data_confirmacao_pagamento: new Date().toISOString()
                            })
                            .eq('id', currentParticipant.id);
                        
                        if (error) throw error;
                        
                        console.log('‚úÖ Pagamento processado com sucesso');
                        
                        // Atualizar dados locais
                        await loadDashboardData();
                        
                        closePaymentModal();
                        showNotification('Pagamento processado com sucesso!', 'success');
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao processar pagamento:', error);
                        showNotification('Erro ao processar pagamento: ' + error.message, 'error');
                    } finally {
                        showLoading(false);
                    }
                }
            );
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentParticipant = null;
        }

        // Modal de Detalhes
        async function openDetailsModal(participantId) {
            console.log('üìã Abrindo detalhes para ID:', participantId);
            
            currentParticipant = allParticipants.find(p => p.id === participantId);
            if (!currentParticipant) return;
            
            const isAdmin = currentUser.email === 'adm@alvo.com';
            
            document.getElementById('detailsModalContent').innerHTML = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <h3>üë§ Informa√ß√µes Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome:</label>
                            <input type="text" id="editName" class="form-control" 
                                   value="${currentParticipant.nome_completo || ''}"
                                   onchange="updateParticipantName()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp:</label>
                            <input type="text" class="form-control" 
                                   value="${currentParticipant.whatsapp || ''}" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sexo:</label>
                            <input type="text" class="form-control" 
                                   value="${currentParticipant.sexo || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Idade:</label>
                            <input type="text" class="form-control" 
                                   value="${currentParticipant.idade || ''}" readonly>
                        </div>
                    </div>
                    
                    <h3>üí∞ Informa√ß√µes de Pagamento</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: var(--dark-bg); padding: 1rem; border-radius: 5px; text-align: center;">
                            <div style="color: ${getStatusColor(getParticipantStatus(currentParticipant))}; font-weight: bold;">
                                ${getParticipantStatus(currentParticipant)}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Status</div>
                        </div>
                        <div style="background: var(--dark-bg); padding: 1rem; border-radius: 5px; text-align: center;">
                            <div style="color: var(--primary-color); font-weight: bold; font-size: 1.2rem;">
                                R$ ${currentParticipant.valor_pago || '0,00'}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Valor Pago</div>
                        </div>
                        <div style="background: var(--dark-bg); padding: 1rem; border-radius: 5px; text-align: center;">
                            <div style="color: var(--secondary-color); font-weight: bold;">
                                ${currentParticipant.forma_pagamento || 'N√£o informado'}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Forma Pagamento</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(${isAdmin ? '3' : '2'}, 1fr); gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-success" onclick="openPaymentModal(${currentParticipant.id}); closeDetailsModal();">
                        üí∞ COBRAR
                    </button>
                    <button class="btn btn-warning" onclick="openEmailModal(${currentParticipant.id}); closeDetailsModal();">
                        üìß ENVIAR E-MAIL
                    </button>
                    ${isAdmin ? `
                    <button class="btn btn-danger" onclick="deleteParticipant(${currentParticipant.id})">
                        üóëÔ∏è EXCLUIR
                    </button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detailsModal').style.display = 'block';
        }

        function getStatusColor(status) {
            switch (status) {
                case 'AGUARDANDO PAGAMENTO':
                    return '#ffc107';
                case 'PAGAMENTO PARCIAL':
                    return '#17a2b8';
                case 'PAGO':
                    return '#28a745';
                default:
                    return '#ffc107';
            }
        }

        async function updateParticipantName() {
            const newName = document.getElementById('editName').value;
            
            try {
                const { error } = await supabase
                    .from('inscricoes')
                    .update({ nome_completo: newName })
                    .eq('id', currentParticipant.id);
                
                if (error) throw error;
                
                currentParticipant.nome_completo = newName;
                await loadDashboardData();
                showNotification('Nome atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar nome:', error);
                showNotification('Erro ao atualizar nome: ' + error.message, 'error');
            }
        }

        async function deleteParticipant(participantId) {
            showConfirmationPopup(
                'Tem certeza que deseja excluir esta inscri√ß√£o? Esta a√ß√£o n√£o pode ser desfeita!',
                async () => {
                    try {
                        const { error } = await supabase
                            .from('inscricoes')
                            .delete()
                            .eq('id', participantId);
                        
                        if (error) throw error;
                        
                        await loadDashboardData();
                        closeDetailsModal();
                        showNotification('Inscri√ß√£o exclu√≠da com sucesso!', 'success');
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao excluir:', error);
                        showNotification('Erro ao excluir: ' + error.message, 'error');
                    }
                }
            );
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
            currentParticipant = null;
        }

        // Modal de E-mail
        async function openEmailModal(participantId) {
            console.log('üìß Abrindo modal de e-mail para ID:', participantId);
            
            currentParticipant = allParticipants.find(p => p.id === participantId);
            if (!currentParticipant) return;
            
            document.getElementById('emailModalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">üë§ Participante:</label>
                    <input type="text" class="form-control" 
                           value="${currentParticipant.nome_completo}" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìß E-mail:</label>
                    <input type="email" id="emailAddress" class="form-control" 
                           value="${currentParticipant['e-mail'] || ''}">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-success" onclick="sendEmail()">
                        üìß ENVIAR
                    </button>
                    <button class="btn btn-danger" onclick="closeEmailModal()">
                        ‚ùå CANCELAR
                    </button>
                </div>
            `;
            
            document.getElementById('emailModal').style.display = 'block';
        }

        async function sendEmail() {
            const emailAddress = document.getElementById('emailAddress').value;
            
            if (!emailAddress) {
                showNotification('E-mail √© obrigat√≥rio!', 'error');
                return;
            }
            
            console.log('üìß Enviando e-mail para:', emailAddress);
            showLoading(true);
            
            try {
                // Simular envio de e-mail (implementar integra√ß√£o real com Resend)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                closeEmailModal();
                showNotification('E-mail enviado com sucesso!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao enviar e-mail:', error);
                showNotification('Erro ao enviar e-mail: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            currentParticipant = null;
        }

        // Dashboard e Lista de Ganhadores (implementar conforme necess√°rio)
        function openDashboard() {
            showNotification('Dashboard em desenvolvimento!', 'warning');
        }

        function openWinnersList() {
            showNotification('Lista de ganhadores em desenvolvimento!', 'warning');
        }

        // Utilit√°rios
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'success') {
            console.log(`üì¢ Notifica√ß√£o (${type}):`, message);
            
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function showConfirmationPopup(message, onConfirm) {
            const popup = document.createElement('div');
            popup.className = 'confirmation-popup';
            popup.innerHTML = `
                <h3>‚ö†Ô∏è Confirma√ß√£o</h3>
                <p>${message}</p>
                <button class="btn btn-success" onclick="confirmAction()">‚úÖ Confirmar</button>
                <button class="btn btn-danger" onclick="cancelAction()">‚ùå Cancelar</button>
            `;
            
            document.body.appendChild(popup);
            
            window.confirmAction = () => {
                document.body.removeChild(popup);
                onConfirm();
                delete window.confirmAction;
                delete window.cancelAction;
            };
            
            window.cancelAction = () => {
                document.body.removeChild(popup);
                delete window.confirmAction;
                delete window.cancelAction;
            };
        }

        function closeAllModals() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('detailsModal').style.display = 'none';
            document.getElementById('emailModal').style.display = 'none';
            currentParticipant = null;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Converter mai√∫sculas no campo de busca
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        });
    </script>
</body>
</html>

