<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Balc√£o - O Retiro 2025</title>
    <style>
        :root {
            --primary: #ff6b35;
            --primary-light: #ff8a5b;
            --primary-dark: #ff4500;
            --bg-dark: #1a1a1a;
            --bg-medium: #2d2d2d;
            --bg-light: #333;
            --text-light: #ccc;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #fbbf24;
            --info: #3b82f6;
            --border-radius: 8px;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium));
            min-height: 100vh;
            color: white;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid var(--bg-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Componentes reutiliz√°veis */
        .btn {
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--primary-light)); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        
        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--bg-light);
            border-radius: var(--border-radius);
            background: #222;
            color: white;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-light);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .card {
            background: #111;
            border: 2px solid var(--bg-light);
            border-radius: 15px;
            padding: 20px;
            transition: var(--transition);
        }
        
        .card:hover {
            border-color: rgba(255, 107, 53, 0.3);
        }
        
        /* Modal otimizado */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: #111;
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            color: white;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Layout espec√≠fico */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .main-system { 
            display: none; 
        }
        
        .header {
            background: #000;
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid var(--bg-light);
            position: relative;
        }
        
        .user-info {
            position: absolute;
            top: 15px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-panel {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 3px solid var(--primary-dark);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stats-item {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            text-align: center;
            transition: var(--transition);
        }
        
        .stats-item:hover {
            transform: scale(1.05);
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .person-card {
            background: #222;
            border: 2px solid var(--bg-light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .person-card:hover {
            border-color: var(--primary);
            background: var(--bg-light);
            transform: translateY(-2px);
        }
        
        .dashboard-container {
            display: none;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #111;
            border: 2px solid var(--bg-light);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }
        
        .metric-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            background: #111;
            border: 2px solid var(--bg-light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        /* Tabelas otimizadas */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--bg-light);
        }
        
        .table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table tr:hover {
            background: rgba(255, 107, 53, 0.1);
        }
        
        /* Notifica√ß√µes otimizadas */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            font-weight: bold;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease;
            transition: var(--transition);
            max-width: 400px;
        }
        
        .notification.success { background: var(--success); color: white; }
        .notification.error { background: var(--danger); color: white; }
        .notification.warning { background: var(--warning); color: white; }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Error states */
        .error {
            background: #660000;
            color: #ff6666;
            border: 1px solid #cc0000;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pendente { background: var(--danger); color: white; }
        .status-pago-parcialmente { background: var(--warning); color: white; }
        .status-pago { background: var(--success); color: white; }
        
        /* Responsividade melhorada */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .user-info { 
                position: static; 
                margin-bottom: 15px; 
                justify-content: center; 
            }
            .stats-grid { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 10px 15px;
                font-size: 0.8em;
            }
            .card {
                padding: 15px;
            }
        }

        /* Print styles otimizados */
        @media print {
            body * { visibility: hidden; }
            .print-content, .print-content * { visibility: visible; }
            .print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
            }
            @page { 
                size: A4; 
                margin: 15mm; 
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="card" style="min-width: 400px; text-align: center;">
            <h1 style="color: var(--primary); font-size: 2.5em; margin-bottom: 15px;">üîê ACESSO</h1>
            <p style="color: var(--text-light); margin-bottom: 30px;">Sistema de Balc√£o ‚Ä¢ O Retiro 2025</p>
            
            <form id="login-form">
                <div style="margin-bottom: 20px; text-align: left;">
                    <label style="color: white; font-weight: 600; margin-bottom: 8px; display: block;">üë§ E-mail:</label>
                    <input type="email" id="login-email" class="input" placeholder="seuemail@alvochurch.com" required autocomplete="email">
                </div>
                
                <div style="margin-bottom: 20px; text-align: left;">
                    <label style="color: white; font-weight: 600; margin-bottom: 8px; display: block;">üîí Senha:</label>
                    <input type="password" id="login-password" class="input" placeholder="Digite sua senha" required autocomplete="current-password">
                </div>
                
                <button type="submit" id="login-btn" class="btn btn-primary" style="width: 100%; padding: 18px;">
                    üöÄ ENTRAR NO SISTEMA
                </button>
            </form>
            
            <div id="login-error" class="error">
                ‚ùå <strong>Erro no login:</strong><br>
                <span id="login-error-message">Verifique suas credenciais</span>
            </div>
        </div>
    </div>

    <!-- Main System -->
    <div id="main-system" class="main-system">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <span>üë§ <span id="user-name">Carregando...</span></span>
                    <button onclick="logout()" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8em;">üö™ Sair</button>
                </div>
                
                <div style="color: white; font-size: 1.2em; margin-bottom: 10px; letter-spacing: 2px;">ALVO - UMA IGREJA QUE PENSA</div>
                <h1 style="color: var(--primary); font-size: 2.5em; font-weight: 900; margin-bottom: 10px;">SISTEMA DE BALC√ÉO</h1>
                <div style="color: var(--text-light);">O RETIRO ‚Ä¢ GEST√ÉO DE PAGAMENTOS</div>
            </div>

            <!-- Painel de Estat√≠sticas -->
            <div class="stats-panel">
                <h2 style="color: white; font-size: 2em; margin-bottom: 15px; text-align: center; text-transform: uppercase; letter-spacing: 3px;">
                    üìä PAINEL DE CONTROLE
                </h2>
                <div class="stats-grid">
                    <div class="stats-item">
                        <div style="font-size: 2.5em; font-weight: 900; color: white;" id="total-homens">0</div>
                        <div style="color: white; font-weight: bold;">Inscritos Homens</div>
                    </div>
                    <div class="stats-item">
                        <div style="font-size: 2.5em; font-weight: 900; color: white;" id="total-mulheres">0</div>
                        <div style="color: white; font-weight: bold;">Inscritas Mulheres</div>
                    </div>
                    <div class="stats-item">
                        <div style="font-size: 2.5em; font-weight: 900; color: white;" id="total-inscricoes">0</div>
                        <div style="color: white; font-weight: bold;">Total de Inscri√ß√µes</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button onclick="showDashboard()" class="btn btn-info" style="width: 100%; padding: 15px;">
                        üìà DASHBOARD COMPLETO
                    </button>
                    <button onclick="generateWinnersList()" class="btn btn-warning" style="width: 100%; padding: 15px;">
                        üèÜ LISTA DE GANHADORES
                    </button>
                </div>
            </div>

            <!-- Sistema Principal -->
            <div id="main-content">
                <div class="main-layout">
                    <!-- Search Panel -->
                    <div class="card">
                        <h2 style="color: var(--primary); font-size: 1.5em; margin-bottom: 20px; text-align: center;">üîç Buscar Participante</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="color: white; font-weight: 600; margin-bottom: 8px; display: block;">Nome do Participante:</label>
                            <input type="text" id="search-name" class="input" placeholder="Digite o nome para buscar..." autocomplete="off">
                        </div>
                        
                        <button id="search-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                            üîç Buscar Participante
                        </button>
                        
                        <div id="search-status" style="text-align: center; color: var(--text-light); margin-bottom: 20px; min-height: 20px;">
                            Digite o nome e clique em buscar
                        </div>

                        <!-- Export Button -->
                        <div style="padding-top: 20px; border-top: 2px solid var(--bg-light);">
                            <button id="export-btn" class="btn btn-success" style="width: 100%;" onclick="exportToExcel()">
                                üìä Exportar Base Completa (Excel)
                            </button>
                            <div style="text-align: center; margin-top: 8px; font-size: 0.8em; color: #666;">
                                Baixa arquivo .xlsx com todos os dados
                            </div>
                        </div>
                    </div>

                    <!-- Results Panel -->
                    <div class="card">
                        <h2 style="color: var(--primary); font-size: 1.5em; margin-bottom: 20px; text-align: center;">üìã Resultados da Busca</h2>
                        
                        <div id="results-container" style="max-height: 600px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                Nenhuma busca realizada ainda
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Container -->
            <div id="dashboard-container" class="dashboard-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: var(--primary); font-size: 2em;">üìà Dashboard de Fechamento</h2>
                    <button onclick="hideDashboard()" class="btn btn-secondary">‚Üê Voltar</button>
                </div>

                <!-- Filtros -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üîç Filtros</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="color: white; margin-bottom: 5px; display: block;">üìÖ Data:</label>
                            <input type="date" id="filter-data" class="input" onchange="updateDashboard()">
                        </div>
                        <div>
                            <label style="color: white; margin-bottom: 5px; display: block;">üë§ Atendente:</label>
                            <select id="filter-atendente" class="input" onchange="updateDashboard()">
                                <option value="">Todos os atendentes</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: white; margin-bottom: 5px; display: block;">üí≥ Forma de Pagamento:</label>
                            <select id="filter-forma" class="input" onchange="updateDashboard()">
                                <option value="">Todas as formas</option>
                                <option value="PIX">PIX</option>
                                <option value="DINHEIRO">Dinheiro</option>
                                <option value="CART√ÉO DE CR√âDITO">Cart√£o de Cr√©dito</option>
                                <option value="CART√ÉO DE D√âBITO">Cart√£o de D√©bito</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: white; margin-bottom: 5px; display: block;">üìä Status:</label>
                            <select id="filter-status" class="input" onchange="updateDashboard()">
                                <option value="">Todos os status</option>
                                <option value="PAGO PARCIALMENTE">Pago Parcialmente</option>
                                <option value="PAGO">Pago</option>
                                <option value="PENDENTE">Pendente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- M√©tricas Principais -->
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="dash-total-inscricoes">0</div>
                        <div class="metric-label">üìä Total Inscri√ß√µes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dash-pre-inscricoes">0</div>
                        <div class="metric-label">üéΩ Pr√©-inscri√ß√µes (R$ 150)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dash-pagos-completo">0</div>
                        <div class="metric-label">‚úÖ Pagos Completo</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dash-valor-pix">0</div>
                        <div class="metric-label">üè¶ PIX</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dash-valor-dinheiro">0</div>
                        <div class="metric-label">üíµ Dinheiro</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dash-valor-cartao">0</div>
                        <div class="metric-label">üí≥ Cart√£o</div>
                    </div>
                </div>

                <!-- Tabela de Inscri√ß√µes -->
                <div class="chart-container">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üìã Inscri√ß√µes Detalhadas</h3>
                    <div style="overflow-x: auto; max-height: 600px;">
                        <table class="table" id="inscricoes-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>WhatsApp</th>
                                    <th>Sexo</th>
                                    <th>Status Pagamento</th>
                                    <th>Forma Pagamento</th>
                                    <th>Atendente</th>
                                    <th>Data Inscri√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="inscricoes-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bot√µes de Exporta√ß√£o -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button onclick="exportDashboard()" class="btn btn-success">üìä Exportar Dashboard</button>
                    <button onclick="exportInscricoes()" class="btn btn-info">üìã Exportar Inscri√ß√µes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); font-size: 1.8em;">üìã Detalhes Completos</h3>
                <button onclick="closeModal('details-modal')" class="btn btn-secondary" style="padding: 8px 15px;">‚ùå Fechar</button>
            </div>
            
            <div id="details-content">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de E-mail -->
    <div id="email-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">üìß Enviar Comprovante por E-mail</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">üë§ Participante:</label>
                <div id="email-participant-name" style="color: white; font-weight: bold; background: #222; padding: 10px; border-radius: 5px;"></div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">üìß E-mail:</label>
                <input type="email" id="email-input" class="input" placeholder="Digite o e-mail do participante">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">üí∞ Resumo da Inscri√ß√£o:</label>
                <div id="email-payment-summary" style="background: #222; padding: 10px; border-radius: 5px; font-size: 0.9em; color: var(--text-light);"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="sendEmailReceipt()" class="btn btn-success">üìß Enviar</button>
                <button onclick="closeModal('email-modal')" class="btn btn-secondary">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Status -->
    <div id="status-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">üí∞ Atualizar Status de Pagamento</h3>
            
            <div id="status-participant-info" style="margin-bottom: 20px; padding: 15px; background: #222; border-radius: 8px;">
                <!-- Informa√ß√µes do participante -->
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="color: white; margin-bottom: 5px; display: block;">üìä Novo Status:</label>
                    <select id="new-status" class="input" onchange="updateValueBasedOnStatus()">
                        <option value="">Selecione...</option>
                        <option value="PR√â-INSCRI√á√ÉO">Pr√©-inscri√ß√£o (R$ 150)</option>
                        <option value="PAGO COMPLETO">Pago Completo (R$ 520)</option>
                        <option value="PENDENTE">Pendente</option>
                    </select>
                </div>
                <div>
                    <label style="color: white; margin-bottom: 5px; display: block;">üí≥ Forma de Pagamento:</label>
                    <select id="new-forma-pagamento" class="input">
                        <option value="">Selecione...</option>
                        <option value="PIX">PIX</option>
                        <option value="DINHEIRO">Dinheiro</option>
                        <option value="CART√ÉO DE CR√âDITO">Cart√£o de Cr√©dito</option>
                        <option value="CART√ÉO DE D√âBITO">Cart√£o de D√©bito</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: white; margin-bottom: 5px; display: block;">üí∞ Valor Pago:</label>
                <input type="text" id="new-valor-pago" class="input" placeholder="Ex: 150,00">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="updateParticipantStatus()" class="btn btn-success">‚úÖ Atualizar</button>
                <button onclick="closeModal('status-modal')" class="btn btn-secondary">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Lista de Ganhadores -->
    <div id="winners-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); font-size: 1.8em;">üèÜ Lista dos 150 Ganhadores de Camisa</h3>
                <button onclick="closeModal('winners-modal')" class="btn btn-secondary">‚ùå Fechar</button>
            </div>
            
            <div id="winners-content" style="max-height: 70vh; overflow-y: auto;">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
            </div>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="exportWinners()" class="btn btn-success">üìä Exportar Lista</button>
                <button onclick="printWinners()" class="btn btn-info">üñ®Ô∏è Imprimir Lista</button>
            </div>
        </div>
    </div>

    <!-- Modal de Recibo -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; background: white; color: black; font-family: 'Courier New', monospace;">
            <div id="receipt-content" class="receipt-content">
                <!-- Conte√∫do do recibo ser√° inserido aqui -->
            </div>
            
            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <button onclick="printReceipt()" class="btn btn-info">üñ®Ô∏è Imprimir</button>
                <button onclick="emailReceiptFromModal()" class="btn btn-warning">üìß Enviar E-mail</button>
                <button onclick="closeModal('receipt-modal')" class="btn btn-secondary">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <!-- √Årea de impress√£o (oculta) -->
    <div id="receipt-print" class="print-content" style="display: none;">
        <!-- Conte√∫do do recibo ser√° inserido aqui -->
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10002;
        flex-direction: column;
        gap: 20px;
    ">
        <div class="spinner"></div>
        <div style="color: white; font-weight: 600;">Carregando...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ===== CONFIGURA√á√ÉO E CONSTANTES =====
        const SUPABASE_URL = 'https://yuikwufjkdzgdzvlotaq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1aWt3dWZqa2R6Z2R6dmxvdGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5ODcwMzcsImV4cCI6MjA2NjU2MzAzN30.UGW0AHHSsIv842Z92F6RjI930fgS-5FmPX0i7kumgYo';
        const RESEND_API_KEY = 're_arnckxhd_7xGQ1cuDeEpC8oBXGtMFHNH4';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== ESTADO GLOBAL OTIMIZADO =====
        const AppState = {
            currentUser: null,
            allParticipants: [],
            filteredParticipants: [],
            currentParticipant: null,
            currentReceipt: null,
            searchTimeout: null,
            isLoading: false
        };

        // ===== CACHE E PERFORMANCE =====
        const Cache = {
            participants: new Map(),
            stats: null,
            lastUpdate: null,
            
            set(key, value) {
                this.participants.set(key, value);
            },
            
            get(key) {
                return this.participants.get(key);
            },
            
            clear() {
                this.participants.clear();
                this.stats = null;
                this.lastUpdate = null;
            },
            
            isStale() {
                return !this.lastUpdate || (Date.now() - this.lastUpdate) > 30000; // 30 segundos
            }
        };

        // ===== UTILIT√ÅRIOS OTIMIZADOS =====
        const Utils = {
            debounce(func, delay) {
                let timeoutId;
                return function (...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function (...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },

            formatDateTime(date) {
                try {
                    const localDate = new Date(date);
                    return new Intl.DateTimeFormat('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'America/Sao_Paulo'
                    }).format(localDate);
                } catch (error) {
                    console.error('Erro ao formatar data:', error);
                    return 'Data inv√°lida';
                }
            },

            sanitizeInput(input) {
                return input.trim().toUpperCase().replace(/[<>\"']/g, '');
            },

            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },

            getStatusClass(status) {
                const statusMap = {
                    'PAGO': 'success',
                    'PAGO PARCIALMENTE': 'warning',
                    'PENDENTE': 'danger'
                };
                return statusMap[status] || 'secondary';
            },

            getStatusText(status) {
                const statusMap = {
                    'PAGO': 'PAGO',
                    'PAGO PARCIALMENTE': 'PAGO PARCIALMENTE',
                    'PENDENTE': 'PENDENTE'
                };
                return statusMap[status] || 'INDEFINIDO';
            }
        };

        // ===== SISTEMA DE LOADING =====
        const LoadingManager = {
            show(message = 'Carregando...') {
                const overlay = document.getElementById('loading-overlay');
                const text = overlay.querySelector('div:last-child');
                text.textContent = message;
                overlay.style.display = 'flex';
                AppState.isLoading = true;
            },

            hide() {
                document.getElementById('loading-overlay').style.display = 'none';
                AppState.isLoading = false;
            }
        };

        // ===== SISTEMA DE NOTIFICA√á√ïES OTIMIZADO =====
        const NotificationManager = {
            queue: [],
            isShowing: false,

            show(message, type = 'success', duration = 4000) {
                this.queue.push({ message, type, duration });
                if (!this.isShowing) {
                    this.processQueue();
                }
            },

            processQueue() {
                if (this.queue.length === 0) {
                    this.isShowing = false;
                    return;
                }

                this.isShowing = true;
                const { message, type, duration } = this.queue.shift();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                        this.processQueue();
                    }, 300);
                }, duration);
            }
        };

        // ===== SISTEMA DE MODAL OTIMIZADO =====
        const ModalManager = {
            open(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            },

            close(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            },

            closeAll() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
            }
        };

        // ===== SISTEMA DE AUTENTICA√á√ÉO OTIMIZADO =====
        const Auth = {
            async login(email, password) {
                try {
                    LoadingManager.show('Fazendo login...');
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email.trim(),
                        password: password
                    });

                    if (error) throw error;

                    AppState.currentUser = data.user;
                    document.getElementById('user-name').textContent = data.user.email.split('@')[0];
                    
                    // Transi√ß√£o suave
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('main-system').style.display = 'block';
                    
                    // Carregar dados iniciais
                    await DataManager.loadInitialData();
                    NotificationManager.show('Login realizado com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro no login:', error);
                    document.getElementById('login-error-message').textContent = error.message;
                    document.getElementById('login-error').style.display = 'block';
                    throw error;
                } finally {
                    LoadingManager.hide();
                }
            },

            async logout() {
                try {
                    await supabase.auth.signOut();
                    AppState.currentUser = null;
                    Cache.clear();
                    
                    document.getElementById('login-container').style.display = 'flex';
                    document.getElementById('main-system').style.display = 'none';
                    
                    // Limpar formul√°rio
                    document.getElementById('login-form').reset();
                    document.getElementById('login-error').style.display = 'none';
                    
                    NotificationManager.show('Logout realizado com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro no logout:', error);
                    NotificationManager.show('Erro ao fazer logout', 'error');
                }
            }
        };

        // ===== GERENCIADOR DE DADOS OTIMIZADO =====
        const DataManager = {
            async loadInitialData() {
                try {
                    LoadingManager.show('Carregando dados...');
                    
                    await Promise.all([
                        this.loadParticipants(),
                        this.updateStats()
                    ]);
                    
                    this.loadAtendentes();
                    Cache.lastUpdate = Date.now();
                    
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    NotificationManager.show('Erro ao carregar dados iniciais', 'error');
                    throw error;
                } finally {
                    LoadingManager.hide();
                }
            },

            async loadParticipants(forceRefresh = false) {
                if (!forceRefresh && !Cache.isStale() && AppState.allParticipants.length > 0) {
                    return AppState.allParticipants;
                }

                try {
                    const { data, error } = await supabase
                        .from('inscricoes')
                        .select('*')
                        .order('data_inscricao', { ascending: false });

                    if (error) throw error;
                    
                    AppState.allParticipants = data || [];
                    Cache.lastUpdate = Date.now();
                    
                    console.log('Participantes carregados:', AppState.allParticipants.length);
                    return AppState.allParticipants;
                    
                } catch (error) {
                    console.error('Erro ao carregar participantes:', error);
                    throw error;
                }
            },

            loadAtendentes() {
                try {
                    const atendentes = [...new Set(
                        AppState.allParticipants
                            .map(p => p.atendente)
                            .filter(a => a && a.trim())
                    )].sort();
                    
                    const select = document.getElementById('filter-atendente');
                    
                    // Limpar op√ß√µes existentes (exceto a primeira)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    atendentes.forEach(atendente => {
                        const option = document.createElement('option');
                        option.value = atendente;
                        option.textContent = atendente;
                        select.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Erro ao carregar atendentes:', error);
                }
            },

            async updateStats() {
                try {
                    // Contar apenas participantes que fizeram algum pagamento
                    const pagantes = AppState.allParticipants.filter(p => 
                        p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO'
                    );
                    
                    const stats = {
                        homens: pagantes.filter(p => p.sexo === 'MASCULINO').length,
                        mulheres: pagantes.filter(p => p.sexo === 'FEMININO').length,
                        total: pagantes.length
                    };

                    // Atualizar interface com anima√ß√£o
                    this.animateStatUpdate('total-homens', stats.homens);
                    this.animateStatUpdate('total-mulheres', stats.mulheres);
                    this.animateStatUpdate('total-inscricoes', stats.total);
                    
                    Cache.stats = stats;
                    
                } catch (error) {
                    console.error('Erro ao atualizar estat√≠sticas:', error);
                }
            },

            animateStatUpdate(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const currentValue = parseInt(element.textContent) || 0;
                const increment = Math.ceil((newValue - currentValue) / 10);
                
                if (increment === 0) {
                    element.textContent = newValue;
                    return;
                }
                
                let current = currentValue;
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
                        current = newValue;
                        clearInterval(timer);
                    }
                    element.textContent = current;
                }, 50);
            }
        };

        // ===== SISTEMA DE BUSCA OTIMIZADO =====
        const SearchManager = {
            init() {
                const searchInput = document.getElementById('search-name');
                const searchBtn = document.getElementById('search-btn');
                
                // Debounced search on input
                searchInput.addEventListener('input', Utils.debounce((e) => {
                    e.target.value = Utils.sanitizeInput(e.target.value);
                    if (e.target.value.length >= 3) {
                        this.search(e.target.value);
                    } else if (e.target.value.length === 0) {
                        this.clearResults();
                    }
                }, 300));
                
                // Search on button click
                searchBtn.addEventListener('click', () => {
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        this.search(searchTerm);
                    }
                });
                
                // Search on Enter
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchTerm = e.target.value.trim();
                        if (searchTerm) {
                            this.search(searchTerm);
                        }
                    }
                });
            },

            async search(searchTerm) {
                if (!searchTerm || AppState.isLoading) return;
                
                const statusDiv = document.getElementById('search-status');
                const resultsContainer = document.getElementById('results-container');
                
                try {
                    statusDiv.innerHTML = '<div class="spinner"></div>';
                    
                    // Buscar participantes
                    const filteredParticipants = AppState.allParticipants.filter(participant => 
                        participant.nome_completo && 
                        participant.nome_completo.toUpperCase().includes(searchTerm.toUpperCase())
                    );

                    if (filteredParticipants.length === 0) {
                        statusDiv.textContent = 'Nenhum participante encontrado';
                        this.clearResults();
                        return;
                    }

                    statusDiv.textContent = `${filteredParticipants.length} participante(s) encontrado(s)`;
                    this.displayResults(filteredParticipants);

                } catch (error) {
                    console.error('Erro na busca:', error);
                    statusDiv.textContent = 'Erro na busca';
                    NotificationManager.show('Erro ao buscar participantes', 'error');
                }
            },

            displayResults(participants) {
                const container = document.getElementById('results-container');
                
                if (!participants || participants.length === 0) {
                    this.clearResults();
                    return;
                }

                container.innerHTML = participants.map(participant => 
                    this.createParticipantCard(participant)
                ).join('');
            },

            createParticipantCard(participant) {
                const statusClass = Utils.getStatusClass(participant.status_pagamento);
                const statusText = Utils.getStatusText(participant.status_pagamento);

                return `
                    <div class="person-card" onclick="ParticipantManager.showDetails('${participant.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="color: var(--primary); margin: 0; font-size: 1.1em;">${participant.nome_completo || 'Nome n√£o informado'}</h3>
                            <span class="status-badge status-${participant.status_pagamento?.toLowerCase().replace(/\s+/g, '-')}">${statusText}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; color: var(--text-light); margin-bottom: 15px;">
                            <div><strong>üì± WhatsApp:</strong> ${participant.whatsapp || 'N√£o informado'}</div>
                            <div><strong>üë• Sexo:</strong> ${participant.sexo || 'N√£o informado'}</div>
                            <div><strong>üí∞ Valor Pago:</strong> ${participant.valor_pago || 'N√£o informado'}</div>
                            <div><strong>üí≥ Forma:</strong> ${participant.forma_pagamento || 'N√£o informado'}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <button onclick="event.stopPropagation(); ParticipantManager.openStatusModal('${participant.id}')" class="btn btn-success" style="padding: 8px; font-size: 0.8em;">
                                üí∞ Atualizar
                            </button>
                            <button onclick="event.stopPropagation(); ParticipantManager.showDetails('${participant.id}')" class="btn btn-info" style="padding: 8px; font-size: 0.8em;">
                                üìã Detalhes
                            </button>
                            <button onclick="event.stopPropagation(); EmailManager.openModal('${participant.id}')" class="btn btn-warning" style="padding: 8px; font-size: 0.8em;">
                                üìß E-mail
                            </button>
                        </div>
                    </div>
                `;
            },

            clearResults() {
                document.getElementById('results-container').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Nenhum resultado encontrado
                    </div>
                `;
            }
        };

        // ===== GERENCIADOR DE PARTICIPANTES =====
        const ParticipantManager = {
            async showDetails(participantId) {
                const participant = AppState.allParticipants.find(p => p.id == participantId);
                if (!participant) {
                    NotificationManager.show('Participante n√£o encontrado', 'error');
                    return;
                }

                const showDeleteButton = AppState.currentUser && AppState.currentUser.email === 'adm@alvo.com';

                const content = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">üë§ Informa√ß√µes Pessoais</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">Nome:</label>
                                <input type="text" id="edit-name" class="input" value="${participant.nome_completo || ''}" onchange="ParticipantManager.updateName('${participantId}', this.value)">
                            </div>
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">WhatsApp:</label>
                                <div style="color: white; background: #222; padding: 10px; border-radius: 5px;">${participant.whatsapp || 'N√£o informado'}</div>
                            </div>
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">Sexo:</label>
                                <div style="color: white; background: #222; padding: 10px; border-radius: 5px;">${participant.sexo || 'N√£o informado'}</div>
                            </div>
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">Idade:</label>
                                <div style="color: white; background: #222; padding: 10px; border-radius: 5px;">${participant.idade || 'N√£o informado'}</div>
                            </div>
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">E-mail:</label>
                                <div style="color: white; background: #222; padding: 10px; border-radius: 5px;">${participant.email || 'N√£o informado'}</div>
                            </div>
                            <div>
                                <label style="color: var(--text-light); margin-bottom: 5px; display: block;">Cidade:</label>
                                <div style="color: white; background: #222; padding: 10px; border-radius: 5px;">${participant.cidade || 'N√£o informado'}</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">üí∞ Informa√ß√µes de Pagamento</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div style="background: #222; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; color: ${Utils.getStatusClass(participant.status_pagamento) === 'success' ? 'var(--success)' : 'var(--warning)'}; font-weight: bold;">${Utils.getStatusText(participant.status_pagamento)}</div>
                                <div style="color: var(--text-light);">Status</div>
                            </div>
                            <div style="background: #222; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; color: var(--primary); font-weight: bold;">${participant.valor_pago || 'N/A'}</div>
                                <div style="color: var(--text-light);">Valor Pago</div>
                            </div>
                            <div style="background: #222; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.2em; color: var(--info); font-weight: bold;">${participant.forma_pagamento || 'N/A'}</div>
                                <div style="color: var(--text-light);">Forma Pagamento</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: ${showDeleteButton ? '1fr 1fr 1fr 1fr' : '1fr 1fr 1fr'}; gap: 10px; margin-top: 20px;">
                        <button onclick="ParticipantManager.openStatusModal('${participantId}')" class="btn btn-success">üí∞ Atualizar Status</button>
                        <button onclick="ReceiptManager.generate(AppState.allParticipants.find(p => p.id == '${participantId}'))" class="btn btn-info">üßæ Gerar Recibo</button>
                        <button onclick="EmailManager.openModal('${participantId}')" class="btn btn-warning">üìß Enviar E-mail</button>
                        ${showDeleteButton ? `<button onclick="ParticipantManager.delete('${participantId}')" class="btn btn-danger">üóëÔ∏è Excluir</button>` : ''}
                    </div>
                `;

                document.getElementById('details-content').innerHTML = content;
                ModalManager.open('details-modal');
            },

            async updateName(participantId, newName) {
                if (!newName || !newName.trim()) {
                    NotificationManager.show('Nome n√£o pode estar vazio', 'error');
                    return;
                }

                try {
                    const sanitizedName = Utils.sanitizeInput(newName);
                    
                    const { error } = await supabase
                        .from('inscricoes')
                        .update({ nome_completo: sanitizedName })
                        .eq('id', participantId);

                    if (error) throw error;

                    // Atualizar dados locais
                    const participant = AppState.allParticipants.find(p => p.id == participantId);
                    if (participant) {
                        participant.nome_completo = sanitizedName;
                    }

                    NotificationManager.show('Nome atualizado com sucesso!', 'success');
                    SearchManager.search(document.getElementById('search-name').value);

                } catch (error) {
                    console.error('Erro ao atualizar nome:', error);
                    NotificationManager.show('Erro ao atualizar nome', 'error');
                }
            },

            openStatusModal(participantId) {
                const participant = AppState.allParticipants.find(p => p.id == participantId);
                if (!participant) {
                    NotificationManager.show('Participante n√£o encontrado', 'error');
                    return;
                }

                AppState.currentParticipant = participant;

                document.getElementById('status-participant-info').innerHTML = `
                    <h4 style="color: var(--primary); margin-bottom: 10px;">${participant.nome_completo}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div><strong>WhatsApp:</strong> ${participant.whatsapp}</div>
                        <div><strong>Status Atual:</strong> ${Utils.getStatusText(participant.status_pagamento)}</div>
                        <div><strong>Valor Pago:</strong> ${participant.valor_pago || 'N/A'}</div>
                    </div>
                `;

                // Pr√©-preencher campos
                document.getElementById('new-status').value = '';
                document.getElementById('new-forma-pagamento').value = participant.forma_pagamento || '';
                document.getElementById('new-valor-pago').value = participant.valor_pago || '';
                
                ModalManager.open('status-modal');
            },

            async updateStatus() {
                if (!AppState.currentParticipant) {
                    NotificationManager.show('Nenhum participante selecionado', 'error');
                    return;
                }

                const newStatus = document.getElementById('new-status').value;
                const newFormaPagamento = document.getElementById('new-forma-pagamento').value;
                const newValorPago = document.getElementById('new-valor-pago').value;

                if (!newStatus || !newFormaPagamento || !newValorPago) {
                    NotificationManager.show('Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }

                try {
                    LoadingManager.show('Atualizando status...');
                    
                    const now = new Date().toISOString();
                    const updateData = {
                        status_pagamento: newStatus === 'PR√â-INSCRI√á√ÉO' ? 'PAGO PARCIALMENTE' : 
                                         newStatus === 'PAGO COMPLETO' ? 'PAGO' : 'PENDENTE',
                        forma_pagamento: newFormaPagamento,
                        valor_pago: newValorPago,
                        data_confirmacao_pagamento: newStatus !== 'PENDENTE' ? now : null,
                        atendente: AppState.currentUser.email.split('@')[0]
                    };

                    const { error } = await supabase
                        .from('inscricoes')
                        .update(updateData)
                        .eq('id', AppState.currentParticipant.id);

                    if (error) throw error;

                    // Atualizar dados locais
                    const participantIndex = AppState.allParticipants.findIndex(p => p.id === AppState.currentParticipant.id);
                    if (participantIndex !== -1) {
                        AppState.allParticipants[participantIndex] = { 
                            ...AppState.allParticipants[participantIndex], 
                            ...updateData 
                        };
                    }
                    
                    ModalManager.close('status-modal');
                    
                    // Gerar recibo se pagamento foi efetuado
                    if (newStatus !== 'PENDENTE') {
                        ReceiptManager.generate({
                            ...AppState.currentParticipant,
                            ...updateData
                        });
                    }
                    
                    // Atualizar interface
                    await DataManager.updateStats();
                    SearchManager.search(document.getElementById('search-name').value);
                    
                    NotificationManager.show('Status atualizado com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    NotificationManager.show('Erro ao atualizar status', 'error');
                } finally {
                    LoadingManager.hide();
                    AppState.currentParticipant = null;
                }
            },

            async delete(participantId) {
                if (!confirm('Tem certeza que deseja excluir esta inscri√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    LoadingManager.show('Excluindo participante...');
                    
                    const { error } = await supabase
                        .from('inscricoes')
                        .delete()
                        .eq('id', participantId);

                    if (error) throw error;

                    // Atualizar dados locais
                    AppState.allParticipants = AppState.allParticipants.filter(p => p.id != participantId);

                    ModalManager.close('details-modal');
                    await DataManager.updateStats();
                    SearchManager.search(document.getElementById('search-name').value);
                    
                    NotificationManager.show('Inscri√ß√£o exclu√≠da com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao excluir participante:', error);
                    NotificationManager.show('Erro ao excluir inscri√ß√£o', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }
        };

        // ===== GERENCIADOR DE RECIBOS =====
        const ReceiptManager = {
            generate(participant) {
                if (!participant) {
                    NotificationManager.show('Dados do participante n√£o encontrados', 'error');
                    return;
                }

                const now = new Date();
                const receiptData = {
                    participant: participant,
                    datetime: Utils.formatDateTime(now),
                    numero: Math.floor(Math.random() * 10000).toString().padStart(4, '0')
                };

                AppState.currentReceipt = receiptData;

                const receiptContent = `
                    <div style="text-align: center; border-bottom: 2px dashed #333; padding-bottom: 15px; margin-bottom: 15px;">
                        <h2 style="margin: 0; color: #ff6b35; font-size: 1.5em;">ALVO - UMA IGREJA QUE PENSA</h2>
                        <h3 style="margin: 5px 0; color: #333; font-size: 1.2em;">O RETIRO 2025</h3>
                        <p style="margin: 0; font-size: 0.9em;">RECIBO DE PAGAMENTO</p>
                    </div>
                    
                    <div style="margin: 15px 0; text-align: left; line-height: 1.6;">
                        <p><strong>Data/Hora:</strong> ${receiptData.datetime}</p>
                        <p><strong>Recibo N¬∫:</strong> ${receiptData.numero}</p>
                        <p><strong>Nome:</strong> ${participant.nome_completo}</p>
                        <p><strong>WhatsApp:</strong> ${participant.whatsapp}</p>
                        <p><strong>Sexo:</strong> ${participant.sexo}</p>
                        <p><strong>Idade:</strong> ${participant.idade || 'N/A'}</p>
                    </div>
                    
                    <div style="border-top: 1px dashed #333; border-bottom: 1px dashed #333; padding: 10px 0; margin: 15px 0;">
                        <p><strong>Valor Pago:</strong> R$ ${participant.valor_pago}</p>
                        <p><strong>Forma:</strong> ${participant.forma_pagamento}</p>
                        <p><strong>Status:</strong> ${Utils.getStatusText(participant.status_pagamento)}</p>
                        <p><strong>Atendente:</strong> ${participant.atendente}</p>
                    </div>
                    
                    <div style="border-top: 2px dashed #333; padding-top: 15px; margin-top: 15px; text-align: center;">
                        <p style="margin: 0; font-size: 0.9em; font-weight: bold;">PAGAMENTO QUITADO!</p>
                        <p style="margin: 5px 0; font-size: 0.9em;">Participa√ß√£o confirmada!</p>
                        <p style="margin: 5px 0; font-size: 0.8em;">Parab√©ns pelo seu posicionamento!</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.7em;">ALVO CHURCH</p>
                    </div>
                `;

                document.getElementById('receipt-content').innerHTML = receiptContent;
                ModalManager.open('receipt-modal');
            },

            print() {
                if (!AppState.currentReceipt) {
                    NotificationManager.show('Nenhum recibo dispon√≠vel para impress√£o', 'error');
                    return;
                }
                
                const printContent = document.getElementById('receipt-content').innerHTML;
                document.getElementById('receipt-print').innerHTML = printContent;
                
                setTimeout(() => {
                    window.print();
                }, 100);
            },

            emailFromModal() {
                if (!AppState.currentReceipt) {
                    NotificationManager.show('Nenhum recibo dispon√≠vel', 'error');
                    return;
                }
                
                ModalManager.close('receipt-modal');
                EmailManager.openModal(AppState.currentReceipt.participant.id);
            }
        };

        // ===== GERENCIADOR DE E-MAIL =====
        const EmailManager = {
            openModal(participantId) {
                const participant = AppState.allParticipants.find(p => p.id == participantId);
                if (!participant) {
                    NotificationManager.show('Participante n√£o encontrado', 'error');
                    return;
                }

                document.getElementById('email-participant-name').textContent = participant.nome_completo;
                document.getElementById('email-input').value = participant.email || '';
                
                const summary = `
Nome: ${participant.nome_completo}
WhatsApp: ${participant.whatsapp}
Status: ${Utils.getStatusText(participant.status_pagamento)}
Valor Pago: ${participant.valor_pago || 'N/A'}
Forma Pagamento: ${participant.forma_pagamento || 'N/A'}
Data Inscri√ß√£o: ${Utils.formatDateTime(participant.data_inscricao)}
                `.trim();
                
                document.getElementById('email-payment-summary').textContent = summary;
                AppState.currentParticipant = participant;
                
                ModalManager.open('email-modal');
            },

            async send() {
                const email = document.getElementById('email-input').value.trim();
                
                if (!email) {
                    NotificationManager.show('Digite um e-mail v√°lido', 'error');
                    return;
                }

                if (!Utils.validateEmail(email)) {
                    NotificationManager.show('Formato de e-mail inv√°lido', 'error');
                    return;
                }

                if (!AppState.currentParticipant) {
                    NotificationManager.show('Erro: participante n√£o encontrado', 'error');
                    return;
                }

                try {
                    LoadingManager.show('Enviando e-mail...');
                    
                    const participant = AppState.currentParticipant;
                    const emailData = {
                        from: 'O Retiro 2025 <noreply@alvochurch.com>',
                        to: [email],
                        subject: `Comprovante de Inscri√ß√£o - O Retiro 2025 - ${participant.nome_completo}`,
                        html: this.generateEmailTemplate(participant)
                    };

                    const response = await fetch('https://api.resend.com/emails', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${RESEND_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(emailData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao enviar e-mail');
                    }

                    NotificationManager.show('E-mail enviado com sucesso!', 'success');
                    ModalManager.close('email-modal');

                } catch (error) {
                    console.error('Erro ao enviar e-mail:', error);
                    NotificationManager.show(`Erro ao enviar e-mail: ${error.message}`, 'error');
                } finally {
                    LoadingManager.hide();
                    AppState.currentParticipant = null;
                }
            },

            generateEmailTemplate(participant) {
                return `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f5f5f5;">
                        <div style="background: linear-gradient(135deg, #ff6b35, #ff8a5b); padding: 30px; text-align: center; color: white;">
                            <h1 style="margin: 0; font-size: 2em;">üèïÔ∏è O RETIRO 2025</h1>
                            <p style="margin: 10px 0 0 0; font-size: 1.1em;">ALVO - UMA IGREJA QUE PENSA</p>
                        </div>
                        
                        <div style="padding: 30px; background: white;">
                            <h2 style="color: #ff6b35; margin-bottom: 20px;">üìã Comprovante de Inscri√ß√£o</h2>
                            
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff6b35;">
                                <h3 style="color: #333; margin-bottom: 15px;">üë§ Dados Pessoais</h3>
                                <p style="margin: 5px 0;"><strong>Nome:</strong> ${participant.nome_completo}</p>
                                <p style="margin: 5px 0;"><strong>WhatsApp:</strong> ${participant.whatsapp}</p>
                                <p style="margin: 5px 0;"><strong>E-mail:</strong> ${participant.email || 'N√£o informado'}</p>
                                <p style="margin: 5px 0;"><strong>Sexo:</strong> ${participant.sexo}</p>
                                <p style="margin: 5px 0;"><strong>Idade:</strong> ${participant.idade || 'N√£o informado'}</p>
                            </div>
                            
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #22c55e;">
                                <h3 style="color: #333; margin-bottom: 15px;">üí∞ Informa√ß√µes de Pagamento</h3>
                                <p style="margin: 5px 0;"><strong>Status:</strong> ${Utils.getStatusText(participant.status_pagamento)}</p>
                                <p style="margin: 5px 0;"><strong>Valor Pago:</strong> R$ ${participant.valor_pago || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>Forma de Pagamento:</strong> ${participant.forma_pagamento || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>Data da Inscri√ß√£o:</strong> ${Utils.formatDateTime(participant.data_inscricao)}</p>
                            </div>
                            
                            <div style="background: #ff6b35; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0;">üéØ Pr√≥ximos Passos</h3>
                                <p style="margin: 0; line-height: 1.6;">Aguarde mais informa√ß√µes sobre o evento. Em caso de d√∫vidas, entre em contato conosco!</p>
                            </div>
                        </div>
                        
                        <div style="background: #333; color: white; padding: 20px; text-align: center; font-size: 0.9em;">
                            <p style="margin: 0;">Este √© um e-mail autom√°tico do Sistema de Balc√£o - O Retiro 2025</p>
                            <p style="margin: 5px 0 0 0;">ALVO - UMA IGREJA QUE PENSA</p>
                        </div>
                    </div>
                `;
            }
        };

        // ===== DASHBOARD OTIMIZADO =====
        const DashboardManager = {
            show() {
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('dashboard-container').style.display = 'block';
                this.update();
            },

            hide() {
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('dashboard-container').style.display = 'none';
            },

            update() {
                try {
                    const filters = this.getFilters();
                    const filteredParticipants = this.applyFilters(AppState.allParticipants, filters);
                    
                    this.updateMetrics(filteredParticipants);
                    this.updateTable(filteredParticipants);
                    
                } catch (error) {
                    console.error('Erro ao atualizar dashboard:', error);
                    NotificationManager.show('Erro ao atualizar dashboard', 'error');
                }
            },

            getFilters() {
                return {
                    data: document.getElementById('filter-data').value,
                    atendente: document.getElementById('filter-atendente').value,
                    forma: document.getElementById('filter-forma').value,
                    status: document.getElementById('filter-status').value
                };
            },

            applyFilters(participants, filters) {
                return participants.filter(participant => {
                    // Filtro por data
                    if (filters.data) {
                        const inscricaoDate = new Date(participant.data_inscricao);
                        const filterDate = new Date(filters.data);
                        const isSameDay = inscricaoDate.toDateString() === filterDate.toDateString();
                        if (!isSameDay) return false;
                    }

                    // Filtro por atendente
                    if (filters.atendente && participant.atendente !== filters.atendente) {
                        return false;
                    }

                    // Filtro por forma de pagamento
                    if (filters.forma && participant.forma_pagamento !== filters.forma) {
                        return false;
                    }

                    // Filtro por status
                    if (filters.status && participant.status_pagamento !== filters.status) {
                        return false;
                    }

                    return true;
                });
            },

            updateMetrics(participants) {
                const metrics = {
                    totalInscricoes: participants.length,
                    preInscricoes: participants.filter(p => p.status_pagamento === 'PAGO PARCIALMENTE').length,
                    pagosCompleto: participants.filter(p => p.status_pagamento === 'PAGO').length,
                    valorPix: participants.filter(p => p.forma_pagamento === 'PIX').length,
                    valorDinheiro: participants.filter(p => p.forma_pagamento === 'DINHEIRO').length,
                    valorCartao: participants.filter(p => 
                        p.forma_pagamento === 'CART√ÉO DE CR√âDITO' || p.forma_pagamento === 'CART√ÉO DE D√âBITO'
                    ).length
                };

                // Atualizar com anima√ß√£o
                Object.entries(metrics).forEach(([key, value]) => {
                    const elementId = `dash-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                    DataManager.animateStatUpdate(elementId, value);
                });
            },

            updateTable(participants) {
                const tbody = document.getElementById('inscricoes-tbody');
                
                if (participants.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Nenhuma inscri√ß√£o encontrada</td></tr>';
                    return;
                }

                tbody.innerHTML = participants.map(p => `
                    <tr onclick="ParticipantManager.showDetails('${p.id}')" style="cursor: pointer; transition: var(--transition);">
                        <td style="font-weight: 500;">${p.nome_completo}</td>
                        <td>${p.whatsapp}</td>
                        <td>${p.sexo}</td>
                        <td><span class="status-badge status-${p.status_pagamento?.toLowerCase().replace(/\s+/g, '-')}">${Utils.getStatusText(p.status_pagamento)}</span></td>
                        <td>${p.forma_pagamento || 'N/A'}</td>
                        <td>${p.atendente || 'N/A'}</td>
                        <td>${Utils.formatDateTime(p.data_inscricao)}</td>
                    </tr>
                `).join('');
            }
        };

        // ===== SISTEMA DE GANHADORES =====
const WinnersManager = {
    async generate() {
        try {
            LoadingManager.show('Gerando lista de ganhadores...');
            
            const winners = AppState.allParticipants
              .filter(p => p.data_confirmacao_pagamento)
               .sort((a, b) => new Date(a.data_inscricao) - new Date(b.data_inscricao))
                .slice(0, 150);

            const content = `
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text-light); line-height: 1.6;">Lista dos primeiros 150 participantes que efetuaram pagamento (parcial ou completo), por ordem de confirma√ß√£o de pagamento.</p>
                    <p style="color: var(--warning); font-weight: bold; margin-top: 10px;">Total de ganhadores: ${winners.length}/150</p>
                </div>
                
                <div style="max-height: 60vh; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Nome</th>
                                <th style="width: 80px;">Sexo</th>
                                <th style="width: 120px;">WhatsApp</th>
                                <th style="width: 120px;">Status</th>
                                <th style="width: 140px;">Data Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${winners.map((participant, index) => `
                                <tr onclick="ParticipantManager.showDetails('${participant.id}')" style="cursor: pointer;">
                                    <td style="font-weight: bold; color: var(--primary);">${index + 1}</td>
                                    <td style="font-weight: 500;">${participant.nome_completo}</td>
                                    <td>${participant.sexo}</td>
                                    <td>${participant.whatsapp}</td>
                                    <td><span class="status-badge status-${participant.status_pagamento?.toLowerCase().replace(/\s+/g, '-')}">${Utils.getStatusText(participant.status_pagamento)}</span></td>
                                    <td>${Utils.formatDateTime(participant.data_confirmacao_pagamento)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('winners-content').innerHTML = content;
            ModalManager.open('winners-modal');

        } catch (error) {
            console.error('Erro ao gerar lista de ganhadores:', error);
            NotificationManager.show('Erro ao gerar lista de ganhadores', 'error');
        } finally {
            LoadingManager.hide();
        }
    },

    export() {
        try {
            const winners = AppState.allParticipants
                .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                .slice(0, 150);

            const winnersData = winners.map((p, index) => ({
                'Posi√ß√£o': index + 1,
                'Nome': p.nome_completo,
                'WhatsApp': p.whatsapp,
                'Sexo': p.sexo,
                'Status': Utils.getStatusText(p.status_pagamento),
                'Data Pagamento': Utils.formatDateTime(p.data_confirmacao_pagamento)
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(winnersData);
            
            ws['!cols'] = [
                { wch: 8 },  // Posi√ß√£o
                { wch: 30 }, // Nome
                { wch: 15 }, // WhatsApp
                { wch: 10 }, // Sexo
                { wch: 15 }, // Status
                { wch: 18 }  // Data Pagamento
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ganhadores de Camisa');
            XLSX.writeFile(wb, `ganhadores_camisa_retiro_2025_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            NotificationManager.show('Lista de ganhadores exportada com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao exportar ganhadores:', error);
            NotificationManager.show('Erro ao exportar lista de ganhadores', 'error');
        }
    },

    print() {
        try {
            const winners = AppState.allParticipants
                .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                .slice(0, 150);

            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #ff6b35; margin-bottom: 10px;">üèïÔ∏è O RETIRO 2025</h1>
                        <h2 style="margin-bottom: 10px;">üèÜ LISTA DOS 150 GANHADORES DE CAMISA</h2>
                        <p style="margin-bottom: 5px;">ALVO - UMA IGREJA QUE PENSA</p>
                        <p>Total: ${winners.length}/150 ganhadores</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #ff6b35; color: white;">
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">#</th>
                                <th style="border: 1px solid #ddd; padding: 6px;">Nome</th>
                                <th style="border: 1px solid #ddd; padding: 6px;">WhatsApp</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Sexo</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Data Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${winners.map((p, index) => `
                                <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold;">${index + 1}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px;">${p.nome_completo}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px;">${p.whatsapp}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${p.sexo}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${Utils.formatDateTime(p.data_confirmacao_pagamento)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
                        Gerado em ${Utils.formatDateTime(new Date())} - Sistema de Balc√£o O Retiro 2025
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Lista de Ganhadores - O Retiro 2025</title>
                    <style>
                        @media print {
                            @page { size: A4; margin: 15mm; }
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 250);
        } catch (error) {
            console.error('Erro ao imprimir ganhadores:', error);
            NotificationManager.show('Erro ao imprimir lista de ganhadores', 'error');
        }
    }
};

        // ===== SISTEMA DE EXPORTA√á√ÉO OTIMIZADO =====
        const ExportManager = {
            async exportToExcel() {
                try {
                    LoadingManager.show('Preparando exporta√ß√£o...');
                    
                    const wb = XLSX.utils.book_new();

                    // Aba 1: Inscri√ß√µes Completas
                    const inscricoesData = AppState.allParticipants.map(p => ({
                        'ID': p.id,
                        'Nome Completo': p.nome_completo,
                        'Sexo': p.sexo,
                        'Idade': p.idade,
                        'WhatsApp': p.whatsapp,
                        'Email': p.email,
                        'Endere√ßo': p.endereco,
                        'N√∫mero': p.numero,
                        'Bairro': p.bairro,
                        'Cidade': p.cidade,
                        'Cor Rede': p.cor_rede,
                        'Vai Servir/Receber': p.vai_servir_receber,
                        'Status Pagamento': p.status_pagamento,
                        'Valor Pago': p.valor_pago,
                        'Forma Pagamento': p.forma_pagamento,
                        'Atendente': p.atendente,
                        'Data Inscri√ß√£o': Utils.formatDateTime(p.data_inscricao),
                        'Data Confirma√ß√£o': p.data_confirmacao_pagamento ? Utils.formatDateTime(p.data_confirmacao_pagamento) : 'N/A',
                        'Comorbidade': p.comorbidade,
                        'Medica√ß√£o': p.medicacao,
                        'Restri√ß√µes Alimentares': p.restricoes_alimentares,
                        'Alergias': p.alergias,
                        'Limita√ß√£o Locomo√ß√£o': p.limitacao_locomocao
                    }));
                    
                    const wsInscricoes = XLSX.utils.json_to_sheet(inscricoesData);
                    
                    // Configurar larguras das colunas
                    wsInscricoes['!cols'] = [
                        { wch: 8 },  // ID
                        { wch: 30 }, // Nome
                        { wch: 10 }, // Sexo
                        { wch: 8 },  // Idade
                        { wch: 15 }, // WhatsApp
                        { wch: 25 }, // Email
                        { wch: 30 }, // Endere√ßo
                        { wch: 8 },  // N√∫mero
                        { wch: 20 }, // Bairro
                        { wch: 20 }, // Cidade
                        { wch: 15 }, // Cor Rede
                        { wch: 15 }, // Vai Servir/Receber
                        { wch: 18 }, // Status Pagamento
                        { wch: 12 }, // Valor Pago
                        { wch: 18 }, // Forma Pagamento
                        { wch: 15 }, // Atendente
                        { wch: 18 }, // Data Inscri√ß√£o
                        { wch: 18 }, // Data Confirma√ß√£o
                        { wch: 15 }, // Comorbidade
                        { wch: 15 }, // Medica√ß√£o
                        { wch: 20 }, // Restri√ß√µes
                        { wch: 15 }, // Alergias
                        { wch: 18 }  // Limita√ß√£o
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, wsInscricoes, 'Inscri√ß√µes');

                    // Aba 2: Resumo Executivo
                    const resumoData = [
                        { 'M√©trica': 'Total de Inscri√ß√µes', 'Valor': AppState.allParticipants.length },
                        { 'M√©trica': 'Homens', 'Valor': AppState.allParticipants.filter(p => p.sexo === 'MASCULINO').length },
                        { 'M√©trica': 'Mulheres', 'Valor': AppState.allParticipants.filter(p => p.sexo === 'FEMININO').length },
                        { 'M√©trica': 'Pago Parcialmente', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PAGO PARCIALMENTE').length },
                        { 'M√©trica': 'Pago Completo', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PAGO').length },
                        { 'M√©trica': 'Pendentes', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PENDENTE').length },
                        { 'M√©trica': 'Pagamentos PIX', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'PIX').length },
                        { 'M√©trica': 'Pagamentos Dinheiro', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'DINHEIRO').length },
                        { 'M√©trica': 'Pagamentos Cart√£o Cr√©dito', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'CART√ÉO DE CR√âDITO').length },
                        { 'M√©trica': 'Pagamentos Cart√£o D√©bito', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'CART√ÉO DE D√âBITO').length }
                    ];
                    
                    const wsResumo = XLSX.utils.json_to_sheet(resumoData);
                    wsResumo['!cols'] = [{ wch: 25 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');

                    // Aba 3: Ganhadores de Camisa (150 primeiros)
                    const winners = AppState.allParticipants
                        .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                        .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                        .slice(0, 150);

                    const winnersData = winners.map((p, index) => ({
                        'Posi√ß√£o': index + 1,
                        'Nome': p.nome_completo,
                        'WhatsApp': p.whatsapp,
                        'Sexo': p.sexo,
                        'Status': p.status_pagamento,
                        'Data Pagamento': Utils.formatDateTime(p.data_confirmacao_pagamento),
                        'Atendente': p.atendente
                    }));
                    
                    const wsWinners = XLSX.utils.json_to_sheet(winnersData);
                    wsWinners['!cols'] = [
                        { wch: 8 },  // Posi√ß√£o
                        { wch: 30 }, // Nome
                        { wch: 15 }, // WhatsApp
                        { wch: 10 }, // Sexo
                        { wch: 18 }, // Status
                        { wch: 18 }, // Data
                        { wch: 15 }  // Atendente
                    ];
                    XLSX.utils.book_append_sheet(wb, wsWinners, 'Ganhadores Camisa');

                    // Aba 4: An√°lise por Atendente
                    const atendentes = [...new Set(AppState.allParticipants.map(p => p.atendente).filter(a => a))];
                    const atendenteData = atendentes.map(atendente => {
                        const participantesAtendente = AppState.allParticipants.filter(p => p.atendente === atendente);
                        return {
                            'Atendente': atendente,
                            'Total Inscri√ß√µes': participantesAtendente.length,
                            'Pago Parcialmente': participantesAtendente.filter(p => p.status_pagamento === 'PAGO PARCIALMENTE').length,
                            'Pago Completo': participantesAtendente.filter(p => p.status_pagamento === 'PAGO').length,
                            'Pendentes': participantesAtendente.filter(p => p.status_pagamento === 'PENDENTE').length,
                            'PIX': participantesAtendente.filter(p => p.forma_pagamento === 'PIX').length,
                            'Dinheiro': participantesAtendente.filter(p => p.forma_pagamento === 'DINHEIRO').length,
                            'Cart√£o': participantesAtendente.filter(p => p.forma_pagamento === 'CART√ÉO DE CR√âDITO' || p.forma_pagamento === 'CART√ÉO DE D√âBITO').length
                        };
                    });
                    
                    const wsAtendentes = XLSX.utils.json_to_sheet(atendenteData);
                    wsAtendentes['!cols'] = Array(8).fill({ wch: 15 });
                    XLSX.utils.book_append_sheet(wb, wsAtendentes, 'Por Atendente');

                    // Salvar arquivo
                    const fileName = `retiro_2025_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    NotificationManager.show('Arquivo Excel exportado com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao exportar Excel:', error);
                    NotificationManager.show('Erro ao exportar arquivo Excel', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }
        };

        // ===== FUN√á√ïES GLOBAIS (para manter compatibilidade) =====
        function logout() { Auth.logout(); }
        function showDashboard() { DashboardManager.show(); }
        function hideDashboard() { DashboardManager.hide(); }
        function updateDashboard() { DashboardManager.update(); }
        function generateWinnersList() { WinnersManager.generate(); }
        function exportWinners() { WinnersManager.export(); }
        function printWinners() { WinnersManager.print(); }
        function exportToExcel() { ExportManager.exportToExcel(); }
        function exportDashboard() { ExportManager.exportToExcel(); }
        function exportInscricoes() { ExportManager.exportToExcel(); }
        function sendEmailReceipt() { EmailManager.send(); }
        function updateParticipantStatus() { ParticipantManager.updateStatus(); }
        function printReceipt() { ReceiptManager.print(); }
        function emailReceiptFromModal() { ReceiptManager.emailFromModal(); }

        function updateValueBasedOnStatus() {
            const status = document.getElementById('new-status').value;
            const valorField = document.getElementById('new-valor-pago');
            
            const valueMap = {
                'PR√â-INSCRI√á√ÉO': '150,00',
                'PAGO COMPLETO': '520,00',
                'PENDENTE': '0,00'
            };
            
            valorField.value = valueMap[status] || '';
        }

        function closeModal(modalId) {
            ModalManager.close(modalId);
        }

        // Fun√ß√µes para compatibilidade com onclick inline
        function closeDetailsModal() { closeModal('details-modal'); }
        function closeEmailModal() { closeModal('email-modal'); }
        function closeStatusModal() { closeModal('status-modal'); }
        function closeWinnersModal() { closeModal('winners-modal'); }
        function closeReceiptModal() { closeModal('receipt-modal'); }

        // ===== INICIALIZA√á√ÉO OTIMIZADA =====
        class App {
            constructor() {
                this.init();
            }

            async init() {
                try {
                    console.log('üöÄ Sistema de Balc√£o v4.0 - O Retiro 2025 - Inicializando...');
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Verificar sess√£o existente
                    await this.checkExistingSession();
                    
                    console.log('‚úÖ Sistema inicializado com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o:', error);
                    NotificationManager.show('Erro na inicializa√ß√£o do sistema', 'error');
                }
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    const loginBtn = document.getElementById('login-btn');
                    const originalText = loginBtn.innerHTML;
                    
                    try {
                        loginBtn.disabled = true;
                        loginBtn.innerHTML = 'üîÑ Entrando...';
                        document.getElementById('login-error').style.display = 'none';
                        
                        await Auth.login(email, password);
                        
                    } catch (error) {
                        // Error j√° √© tratado no Auth.login
                    } finally {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = originalText;
                    }
                });

                // Initialize search
                SearchManager.init();

                // Modal clicks (fechar ao clicar fora)
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        ModalManager.close(e.target.id);
                    }
                });

                // ESC key para fechar modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        ModalManager.closeAll();
                    }
                });

                // Prevenir submiss√£o acidental de formul√°rios
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.tagName !== 'BUTTON' && e.target.type !== 'submit') {
                        const form = e.target.closest('form');
                        if (form && form.id !== 'login-form') {
                            e.preventDefault();
                        }
                    }
                });

                // Auto-refresh de dados a cada 5 minutos
                setInterval(async () => {
                    if (AppState.currentUser && !AppState.isLoading) {
                        try {
                            await DataManager.loadParticipants(true);
                            await DataManager.updateStats();
                            console.log('üîÑ Dados atualizados automaticamente');
                        } catch (error) {
                            console.error('Erro no auto-refresh:', error);
                        }
                    }
                }, 300000); // 5 minutos

                // Detectar mudan√ßas de conectividade
                window.addEventListener('online', () => {
                    NotificationManager.show('Conex√£o restaurada', 'success');
                    if (AppState.currentUser) {
                        DataManager.loadParticipants(true);
                    }
                });

                window.addEventListener('offline', () => {
                    NotificationManager.show('Sem conex√£o com a internet', 'warning');
                });
            }

            async checkExistingSession() {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session?.user) {
                        AppState.currentUser = session.user;
                        document.getElementById('user-name').textContent = session.user.email.split('@')[0];
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-system').style.display = 'block';
                        
                        await DataManager.loadInitialData();
                        console.log('üîê Sess√£o restaurada automaticamente');
                    }
                } catch (error) {
                    console.error('Erro ao verificar sess√£o:', error);
                }
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });

        // ===== SERVICE WORKER PARA CACHE (OPCIONAL) =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW falhou ao registrar:', error);
                    });
            });
        }

        // ===== TRATAMENTO DE ERROS GLOBAIS =====
        window.addEventListener('error', (event) => {
            console.error('Erro global capturado:', event.error);
            NotificationManager.show('Ocorreu um erro inesperado', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejeitada:', event.reason);
            NotificationManager.show('Erro de conex√£o ou processamento', 'error');
        });

    </script>
</body>
</html>
                            </table>
                        </div>
                    `;

                    document.getElementById('winners-content').innerHTML = content;
                    ModalManager.open('winners-modal');

                } catch (error) {
                    console.error('Erro ao gerar lista de ganhadores:', error);
                    NotificationManager.show('Erro ao gerar lista de ganhadores', 'error');
                } finally {
                    LoadingManager.hide();
                }
            },

            export() {
                try {
                    const winners = AppState.allParticipants
                        .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                        .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                        .slice(0, 150);

                    const winnersData = winners.map((p, index) => ({
                        'Posi√ß√£o': index + 1,
                        'Nome': p.nome_completo,
                        'WhatsApp': p.whatsapp,
                        'Sexo': p.sexo,
                        'Status': Utils.getStatusText(p.status_pagamento),
                        'Data Pagamento': Utils.formatDateTime(p.data_confirmacao_pagamento)
                    }));

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(winnersData);
                    
                    // Configurar larguras das colunas
                    ws['!cols'] = [
                        { wch: 8 },  // Posi√ß√£o
                        { wch: 30 }, // Nome
                        { wch: 15 }, // WhatsApp
                        { wch: 10 }, // Sexo
                        { wch: 15 }, // Status
                        { wch: 18 }  // Data Pagamento
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, 'Ganhadores de Camisa');
                    XLSX.writeFile(wb, `ganhadores_camisa_retiro_2025_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    NotificationManager.show('Lista de ganhadores exportada com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro ao exportar ganhadores:', error);
                    NotificationManager.show('Erro ao exportar lista de ganhadores', 'error');
                }
            },

            print() {
                try {
                    const winners = AppState.allParticipants
                        .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                        .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                        .slice(0, 150);

                    const printContent = `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <h1 style="color: #ff6b35; margin-bottom: 10px;">üèïÔ∏è O RETIRO 2025</h1>
                                <h2 style="margin-bottom: 10px;">üèÜ LISTA DOS 150 GANHADORES DE CAMISA</h2>
                                <p style="margin-bottom: 5px;">ALVO - UMA IGREJA QUE PENSA</p>
                                <p>Total: ${winners.length}/150 ganhadores</p>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: #ff6b35; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">#</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Nome</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">WhatsApp</th>
                                        <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Sexo</th>
                                        <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">Data Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${winners.map((p, index) => `
                                        <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold;">${index + 1}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px;">${p.nome_completo}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px;">${p.whatsapp}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${p.sexo}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${Utils.formatDateTime(p.data_confirmacao_pagamento)}</td>
                                        </tr>
                                    `).join('')}
</tbody>
                            </table>
                            
                            <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
                                Gerado em ${Utils.formatDateTime(new Date())} - Sistema de Balc√£o O Retiro 2025
                            </div>
                        </div>
                    `;

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Lista de Ganhadores - O Retiro 2025</title>
                            <style>
                                @media print {
                                    @page { size: A4; margin: 15mm; }
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.focus();
                    setTimeout(() => printWindow.print(), 250);
                } catch (error) {
                    console.error('Erro ao imprimir ganhadores:', error);
                    NotificationManager.show('Erro ao imprimir lista de ganhadores', 'error');
                }
            }
        };

        // ===== SISTEMA DE EXPORTA√á√ÉO OTIMIZADO =====
        const ExportManager = {
            async exportToExcel() {
                try {
                    LoadingManager.show('Preparando exporta√ß√£o...');
                    
                    const wb = XLSX.utils.book_new();

                    // Aba 1: Inscri√ß√µes Completas
                    const inscricoesData = AppState.allParticipants.map(p => ({
                        'ID': p.id,
                        'Nome Completo': p.nome_completo,
                        'Sexo': p.sexo,
                        'Idade': p.idade,
                        'WhatsApp': p.whatsapp,
                        'Email': p.email,
                        'Endere√ßo': p.endereco,
                        'N√∫mero': p.numero,
                        'Bairro': p.bairro,
                        'Cidade': p.cidade,
                        'Cor Rede': p.cor_rede,
                        'Vai Servir/Receber': p.vai_servir_receber,
                        'Status Pagamento': p.status_pagamento,
                        'Valor Pago': p.valor_pago,
                        'Forma Pagamento': p.forma_pagamento,
                        'Atendente': p.atendente,
                        'Data Inscri√ß√£o': Utils.formatDateTime(p.data_inscricao),
                        'Data Confirma√ß√£o': p.data_confirmacao_pagamento ? Utils.formatDateTime(p.data_confirmacao_pagamento) : 'N/A',
                        'Comorbidade': p.comorbidade,
                        'Medica√ß√£o': p.medicacao,
                        'Restri√ß√µes Alimentares': p.restricoes_alimentares,
                        'Alergias': p.alergias,
                        'Limita√ß√£o Locomo√ß√£o': p.limitacao_locomocao
                    }));
                    
                    const wsInscricoes = XLSX.utils.json_to_sheet(inscricoesData);
                    
                    // Configurar larguras das colunas
                    wsInscricoes['!cols'] = [
                        { wch: 8 },  // ID
                        { wch: 30 }, // Nome
                        { wch: 10 }, // Sexo
                        { wch: 8 },  // Idade
                        { wch: 15 }, // WhatsApp
                        { wch: 25 }, // Email
                        { wch: 30 }, // Endere√ßo
                        { wch: 8 },  // N√∫mero
                        { wch: 20 }, // Bairro
                        { wch: 20 }, // Cidade
                        { wch: 15 }, // Cor Rede
                        { wch: 15 }, // Vai Servir/Receber
                        { wch: 18 }, // Status Pagamento
                        { wch: 12 }, // Valor Pago
                        { wch: 18 }, // Forma Pagamento
                        { wch: 15 }, // Atendente
                        { wch: 18 }, // Data Inscri√ß√£o
                        { wch: 18 }, // Data Confirma√ß√£o
                        { wch: 15 }, // Comorbidade
                        { wch: 15 }, // Medica√ß√£o
                        { wch: 20 }, // Restri√ß√µes
                        { wch: 15 }, // Alergias
                        { wch: 18 }  // Limita√ß√£o
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, wsInscricoes, 'Inscri√ß√µes');

                    // Aba 2: Resumo Executivo
                    const resumoData = [
                        { 'M√©trica': 'Total de Inscri√ß√µes', 'Valor': AppState.allParticipants.length },
                        { 'M√©trica': 'Homens', 'Valor': AppState.allParticipants.filter(p => p.sexo === 'MASCULINO').length },
                        { 'M√©trica': 'Mulheres', 'Valor': AppState.allParticipants.filter(p => p.sexo === 'FEMININO').length },
                        { 'M√©trica': 'Pago Parcialmente', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PAGO PARCIALMENTE').length },
                        { 'M√©trica': 'Pago Completo', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PAGO').length },
                        { 'M√©trica': 'Pendentes', 'Valor': AppState.allParticipants.filter(p => p.status_pagamento === 'PENDENTE').length },
                        { 'M√©trica': 'Pagamentos PIX', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'PIX').length },
                        { 'M√©trica': 'Pagamentos Dinheiro', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'DINHEIRO').length },
                        { 'M√©trica': 'Pagamentos Cart√£o Cr√©dito', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'CART√ÉO DE CR√âDITO').length },
                        { 'M√©trica': 'Pagamentos Cart√£o D√©bito', 'Valor': AppState.allParticipants.filter(p => p.forma_pagamento === 'CART√ÉO DE D√âBITO').length }
                    ];
                    
                    const wsResumo = XLSX.utils.json_to_sheet(resumoData);
                    wsResumo['!cols'] = [{ wch: 25 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');

                    // Aba 3: Ganhadores de Camisa (150 primeiros)
                    const winners = AppState.allParticipants
                        .filter(p => (p.status_pagamento === 'PAGO PARCIALMENTE' || p.status_pagamento === 'PAGO') && p.data_confirmacao_pagamento)
                        .sort((a, b) => new Date(a.data_confirmacao_pagamento) - new Date(b.data_confirmacao_pagamento))
                        .slice(0, 150);

                    const winnersData = winners.map((p, index) => ({
                        'Posi√ß√£o': index + 1,
                        'Nome': p.nome_completo,
                        'WhatsApp': p.whatsapp,
                        'Sexo': p.sexo,
                        'Status': p.status_pagamento,
                        'Data Pagamento': Utils.formatDateTime(p.data_confirmacao_pagamento),
                        'Atendente': p.atendente
                    }));
                    
                    const wsWinners = XLSX.utils.json_to_sheet(winnersData);
                    wsWinners['!cols'] = [
                        { wch: 8 },  // Posi√ß√£o
                        { wch: 30 }, // Nome
                        { wch: 15 }, // WhatsApp
                        { wch: 10 }, // Sexo
                        { wch: 18 }, // Status
                        { wch: 18 }, // Data
                        { wch: 15 }  // Atendente
                    ];
                    XLSX.utils.book_append_sheet(wb, wsWinners, 'Ganhadores Camisa');

                    // Aba 4: An√°lise por Atendente
                    const atendentes = [...new Set(AppState.allParticipants.map(p => p.atendente).filter(a => a))];
                    const atendenteData = atendentes.map(atendente => {
                        const participantesAtendente = AppState.allParticipants.filter(p => p.atendente === atendente);
                        return {
                            'Atendente': atendente,
                            'Total Inscri√ß√µes': participantesAtendente.length,
                            'Pago Parcialmente': participantesAtendente.filter(p => p.status_pagamento === 'PAGO PARCIALMENTE').length,
                            'Pago Completo': participantesAtendente.filter(p => p.status_pagamento === 'PAGO').length,
                            'Pendentes': participantesAtendente.filter(p => p.status_pagamento === 'PENDENTE').length,
                            'PIX': participantesAtendente.filter(p => p.forma_pagamento === 'PIX').length,
                            'Dinheiro': participantesAtendente.filter(p => p.forma_pagamento === 'DINHEIRO').length,
                            'Cart√£o': participantesAtendente.filter(p => p.forma_pagamento === 'CART√ÉO DE CR√âDITO' || p.forma_pagamento === 'CART√ÉO DE D√âBITO').length
                        };
                    });
                    
                    const wsAtendentes = XLSX.utils.json_to_sheet(atendenteData);
                    wsAtendentes['!cols'] = Array(8).fill({ wch: 15 });
                    XLSX.utils.book_append_sheet(wb, wsAtendentes, 'Por Atendente');

                    // Salvar arquivo
                    const fileName = `retiro_2025_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    NotificationManager.show('Arquivo Excel exportado com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao exportar Excel:', error);
                    NotificationManager.show('Erro ao exportar arquivo Excel', 'error');
                } finally {
                    LoadingManager.hide();
                }
            }
        };

        // ===== FUN√á√ïES GLOBAIS (para manter compatibilidade) =====
        function logout() { Auth.logout(); }
        function showDashboard() { DashboardManager.show(); }
        function hideDashboard() { DashboardManager.hide(); }
        function updateDashboard() { DashboardManager.update(); }
        function generateWinnersList() { WinnersManager.generate(); }
        function exportWinners() { WinnersManager.export(); }
        function printWinners() { WinnersManager.print(); }
        function exportToExcel() { ExportManager.exportToExcel(); }
        function exportDashboard() { ExportManager.exportToExcel(); }
        function exportInscricoes() { ExportManager.exportToExcel(); }
        function sendEmailReceipt() { EmailManager.send(); }
        function updateParticipantStatus() { ParticipantManager.updateStatus(); }
        function printReceipt() { ReceiptManager.print(); }
        function emailReceiptFromModal() { ReceiptManager.emailFromModal(); }

        function updateValueBasedOnStatus() {
            const status = document.getElementById('new-status').value;
            const valorField = document.getElementById('new-valor-pago');
            
            const valueMap = {
                'PR√â-INSCRI√á√ÉO': '150,00',
                'PAGO COMPLETO': '520,00',
                'PENDENTE': '0,00'
            };
            
            valorField.value = valueMap[status] || '';
        }

        function closeModal(modalId) {
            ModalManager.close(modalId);
        }

        // Fun√ß√µes para compatibilidade com onclick inline
        function closeDetailsModal() { closeModal('details-modal'); }
        function closeEmailModal() { closeModal('email-modal'); }
        function closeStatusModal() { closeModal('status-modal'); }
        function closeWinnersModal() { closeModal('winners-modal'); }
        function closeReceiptModal() { closeModal('receipt-modal'); }

        // ===== INICIALIZA√á√ÉO OTIMIZADA =====
        class App {
            constructor() {
                this.init();
            }

            async init() {
                try {
                    console.log('üöÄ Sistema de Balc√£o v4.0 - O Retiro 2025 - Inicializando...');
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Verificar sess√£o existente
                    await this.checkExistingSession();
                    
                    console.log('‚úÖ Sistema inicializado com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o:', error);
                    NotificationManager.show('Erro na inicializa√ß√£o do sistema', 'error');
                }
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    const loginBtn = document.getElementById('login-btn');
                    const originalText = loginBtn.innerHTML;
                    
                    try {
                        loginBtn.disabled = true;
                        loginBtn.innerHTML = 'üîÑ Entrando...';
                        document.getElementById('login-error').style.display = 'none';
                        
                        await Auth.login(email, password);
                        
                    } catch (error) {
                        // Error j√° √© tratado no Auth.login
                    } finally {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = originalText;
                    }
                });

                // Initialize search
                SearchManager.init();

                // Modal clicks (fechar ao clicar fora)
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        ModalManager.close(e.target.id);
                    }
                });

                // ESC key para fechar modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        ModalManager.closeAll();
                    }
                });

                // Prevenir submiss√£o acidental de formul√°rios
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.tagName !== 'BUTTON' && e.target.type !== 'submit') {
                        const form = e.target.closest('form');
                        if (form && form.id !== 'login-form') {
                            e.preventDefault();
                        }
                    }
                });

                // Auto-refresh de dados a cada 5 minutos
                setInterval(async () => {
                    if (AppState.currentUser && !AppState.isLoading) {
                        try {
                            await DataManager.loadParticipants(true);
                            await DataManager.updateStats();
                            console.log('üîÑ Dados atualizados automaticamente');
                        } catch (error) {
                            console.error('Erro no auto-refresh:', error);
                        }
                    }
                }, 300000); // 5 minutos

                // Detectar mudan√ßas de conectividade
                window.addEventListener('online', () => {
                    NotificationManager.show('Conex√£o restaurada', 'success');
                    if (AppState.currentUser) {
                        DataManager.loadParticipants(true);
                    }
                });

                window.addEventListener('offline', () => {
                    NotificationManager.show('Sem conex√£o com a internet', 'warning');
                });
            }

            async checkExistingSession() {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session?.user) {
                        AppState.currentUser = session.user;
                        document.getElementById('user-name').textContent = session.user.email.split('@')[0];
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-system').style.display = 'block';
                        
                        await DataManager.loadInitialData();
                        console.log('üîê Sess√£o restaurada automaticamente');
                    }
                } catch (error) {
                    console.error('Erro ao verificar sess√£o:', error);
                }
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });

        // ===== SERVICE WORKER PARA CACHE (OPCIONAL) =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW falhou ao registrar:', error);
                    });
            });
        }

        // ===== TRATAMENTO DE ERROS GLOBAIS =====
        window.addEventListener('error', (event) => {
            console.error('Erro global capturado:', event.error);
            NotificationManager.show('Ocorreu um erro inesperado', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejeitada:', event.reason);
            NotificationManager.show('Erro de conex√£o ou processamento', 'error');
        });

    </script>
</body>
</html>
